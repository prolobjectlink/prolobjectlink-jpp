<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>AbstractSchema.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">prolobjectlink-jpp</a> &gt; <a href="index.source.html" class="el_package">org.prolobjectlink.db</a> &gt; <span class="el_source">AbstractSchema.java</span></div><h1>AbstractSchema.java</h1><pre class="source lang-java linenums">/*
 * #%L
 * prolobjectlink-jpp
 * %%
 * Copyright (C) 2019 Prolobjectlink Project
 * %%
 * Redistribution and use in source and binary forms, with or without modification,
 * are permitted provided that the following conditions are met:
 * 
 * 1. Redistributions of source code must retain the above copyright notice, this
 *    list of conditions and the following disclaimer.
 * 
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 * 
 * 3. Neither the name of the Prolobjectlink Project nor the names of its contributors
 *    may be used to endorse or promote products derived from this software without
 *    specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
 * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
 * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
 * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
 * OF THE POSSIBILITY OF SUCH DAMAGE.
 * #L%
 */
package org.prolobjectlink.db;

import java.io.File;
import java.lang.reflect.Field;
import java.util.ArrayList;
import java.util.Collection;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.prolobjectlink.Direction;
import org.prolobjectlink.db.prolog.PrologDatabaseFunction;
import org.prolobjectlink.db.prolog.PrologDatabaseTrigger;
import org.prolobjectlink.db.prolog.PrologDatabaseView;

import io.github.prolobjectlink.prolog.PrologEngine;
import io.github.prolobjectlink.prolog.PrologProvider;

/**
 * 
 * @author Jose Zalacain
 * @since 1.0
 */
public abstract class AbstractSchema implements Schema {

	private int version;
	private final String location;
	private final DatabaseUser owner;

	//
	private final transient Storage storage;
	private final transient PrologProvider provider;
	private final transient ContainerFactory containerFactory;

	//
	private final Map&lt;String, DatabaseView&gt; views;
	private final Map&lt;String, DatabaseUser&gt; users;
	private final Map&lt;String, DatabaseClass&gt; classes;
	private final Map&lt;String, DatabaseTrigger&gt; triggers;
	private final Map&lt;String, DatabaseFunction&gt; functions;
	private final Map&lt;String, DatabaseSequence&gt; sequences;

	private static final long serialVersionUID = 2324575651388389914L;

	private DatabaseClass newDatabaseClass(Class&lt;?&gt; clazz, String comment) {
<span class="nc" id="L79">		DatabaseClass c = new DatabaseClass(clazz, comment, this);</span>
<span class="nc" id="L80">		Field[] fields = clazz.getDeclaredFields();</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">		for (int i = 0; i &lt; fields.length; i++) {</span>
<span class="nc" id="L82">			Field field = fields[i];</span>
<span class="nc" id="L83">			String name = field.getName();</span>
<span class="nc" id="L84">			Class&lt;?&gt; type = field.getType();</span>
<span class="nc" id="L85">			c.addField(name, &quot;&quot;, i, type);</span>
		}
<span class="nc" id="L87">		return c;</span>
	}

	private DatabaseClass newDatabaseClass(String clazz, String comment) {
<span class="nc" id="L91">		return new DatabaseClass(clazz, comment, this);</span>
	}

	private DatabaseFunction newDatabaseFunction(String name, String comment) {
<span class="nc" id="L95">		String path0 = location.substring(0, location.lastIndexOf(File.separatorChar));</span>
<span class="nc" id="L96">		String path1 = path0.replace(File.separatorChar, '/') + &quot;/functions.pl&quot;;</span>
<span class="nc" id="L97">		return new PrologDatabaseFunction(name, comment, this, path1, provider);</span>
	}

	private DatabaseTrigger newDatabaseTrigger(String name, String comment) {
<span class="nc" id="L101">		String path0 = location.substring(0, location.lastIndexOf(File.separatorChar));</span>
<span class="nc" id="L102">		String path1 = path0.replace(File.separatorChar, '/') + &quot;/triggers.pl&quot;;</span>
<span class="nc" id="L103">		return new PrologDatabaseTrigger(name, comment, this, path1, provider);</span>
	}

	private DatabaseView newDatabaseView(Class&lt;?&gt; target, String comment) {
<span class="nc" id="L107">		String path0 = location.substring(0, location.lastIndexOf(File.separatorChar));</span>
<span class="nc" id="L108">		String path1 = path0.replace(File.separatorChar, '/') + &quot;/views.pl&quot;;</span>
<span class="nc" id="L109">		return new PrologDatabaseView(path1, target, comment, this, provider);</span>
	}

<span class="nc" id="L112">	public AbstractSchema(String location, PrologProvider provider, ContainerFactory factory, DatabaseUser owner) {</span>
<span class="nc" id="L113">		this.storage = factory.createStorage(location + File.separator + &quot;metadata&quot; + File.separator + &quot;schema.pl&quot;);</span>
<span class="nc" id="L114">		this.functions = new LinkedHashMap&lt;String, DatabaseFunction&gt;();</span>
<span class="nc" id="L115">		this.sequences = new LinkedHashMap&lt;String, DatabaseSequence&gt;();</span>
<span class="nc" id="L116">		this.triggers = new LinkedHashMap&lt;String, DatabaseTrigger&gt;();</span>
<span class="nc" id="L117">		this.classes = new LinkedHashMap&lt;String, DatabaseClass&gt;();</span>
<span class="nc" id="L118">		this.users = new LinkedHashMap&lt;String, DatabaseUser&gt;();</span>
<span class="nc" id="L119">		this.views = new LinkedHashMap&lt;String, DatabaseView&gt;();</span>
<span class="nc" id="L120">		this.location = location + File.separator + &quot;metadata&quot;;</span>
<span class="nc" id="L121">		this.containerFactory = factory;</span>
<span class="nc" id="L122">		this.provider = provider;</span>
<span class="nc" id="L123">		this.owner = owner;</span>
<span class="nc" id="L124">		this.version = 0;</span>
<span class="nc" id="L125">	}</span>

	public final String generate() {
<span class="nc" id="L128">		StringBuilder buffer = new StringBuilder();</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">		for (DatabaseClass clazz : classes.values()) {</span>
<span class="nc" id="L130">			buffer.append(clazz.generate());</span>
<span class="nc" id="L131">		}</span>
<span class="nc" id="L132">		return &quot;&quot; + buffer + &quot;&quot;;</span>
	}

	public final List&lt;Class&lt;?&gt;&gt; compile() {
<span class="nc" id="L136">		int size = classes.size();</span>
<span class="nc" id="L137">		List&lt;Class&lt;?&gt;&gt; l = new ArrayList&lt;Class&lt;?&gt;&gt;(size);</span>
<span class="nc" id="L138">		DynamicClassLoader dcl = new DynamicClassLoader();</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">		for (DatabaseClass c : classes.values()) {</span>
<span class="nc" id="L140">			l.add(dcl.defineClass(c.getName(), c.compile()));</span>
<span class="nc" id="L141">		}</span>
<span class="nc" id="L142">		return l;</span>
	}

	public final boolean isRelationalType(Class&lt;?&gt; type) {
<span class="nc bnc" id="L146" title="All 4 branches missed.">		return !isJavaLangType(type) &amp;&amp; isJavaUtilType(type);</span>
	}

	public final boolean isJavaUtilType(Class&lt;?&gt; type) {
<span class="nc bnc" id="L150" title="All 8 branches missed.">		return isSet(type) || isList(type) || isCollection(type) || isMap(type);</span>
	}

	public final boolean isMap(Class&lt;?&gt; type) {
<span class="nc" id="L154">		return type.equals(Map.class);</span>
	}

	public final boolean isCollection(Class&lt;?&gt; type) {
<span class="nc" id="L158">		return type.equals(Collection.class);</span>
	}

	public final boolean isList(Class&lt;?&gt; type) {
<span class="nc" id="L162">		return type.equals(List.class);</span>
	}

	public final boolean isSet(Class&lt;?&gt; type) {
<span class="nc" id="L166">		return type.equals(Set.class);</span>
	}

	public final boolean isJavaLangType(Class&lt;?&gt; type) {
<span class="nc" id="L170">		Package langPackage = Object.class.getPackage();</span>
<span class="nc" id="L171">		Package typePackage = type.getPackage();</span>
<span class="nc" id="L172">		return typePackage.equals(langPackage);</span>
	}

	public final DatabaseClass addClass(Class&lt;?&gt; clazz, String comment) {
<span class="nc" id="L176">		DatabaseClass c = newDatabaseClass(clazz, comment);</span>
<span class="nc" id="L177">		classes.put(clazz.getName(), c);</span>
<span class="nc" id="L178">		return c;</span>
	}

	/**
	 * Add a class to the current schema
	 * 
	 * @param className name for the class
	 * @return database class instance.
	 * @since 1.0
	 */
	public final DatabaseClass addClass(String className, String comment) {
<span class="nc" id="L189">		DatabaseClass c = newDatabaseClass(className, comment);</span>
<span class="nc" id="L190">		classes.put(className, c);</span>
<span class="nc" id="L191">		return c;</span>
	}

	/**
	 * Add a class to the current schema and set a parent super class.
	 * 
	 * @param className  name for the class
	 * @param superClass parent superclass
	 * @return database class instance.
	 * @since 1.0
	 */
	public final DatabaseClass addClass(String className, String comment, DatabaseClass superClass) {
<span class="nc" id="L203">		DatabaseClass c = newDatabaseClass(className, comment);</span>
<span class="nc" id="L204">		classes.put(className, c.setSuperClass(superClass));</span>
<span class="nc" id="L205">		return c;</span>
	}

	/**
	 * Add a class to the current schema and set a parent super classes.
	 * 
	 * @param className    name for the class
	 * @param superClasses parent super classes
	 * @return database class instance
	 * @since 1.0
	 */
	public final DatabaseClass addClass(String className, String comment, DatabaseClass... superClasses) {
<span class="nc" id="L217">		DatabaseClass c = newDatabaseClass(className, comment);</span>
<span class="nc bnc" id="L218" title="All 4 branches missed.">		if (superClasses != null &amp;&amp; superClasses.length &gt;= 1) {</span>
<span class="nc" id="L219">			c.setSuperClass(superClasses[0]);</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">			for (int i = 1; i &lt; superClasses.length; i++) {</span>
<span class="nc" id="L221">				DatabaseClass superClass = superClasses[i];</span>
<span class="nc" id="L222">				c.addSuperClass(superClass);</span>
			}
		}
<span class="nc" id="L225">		classes.put(className, c);</span>
<span class="nc" id="L226">		return c;</span>
	}

	public final DatabaseClass addAbstractClass(Class&lt;?&gt; clazz, String comment) {
<span class="nc" id="L230">		DatabaseClass c = newDatabaseClass(clazz, comment);</span>
<span class="nc" id="L231">		c.setAbstract(true).setJavaClass(clazz);</span>
<span class="nc" id="L232">		classes.put(clazz.getSimpleName(), c);</span>
<span class="nc" id="L233">		return c;</span>
	}

	public final DatabaseClass addAbstractClass(String n, String comment) {
<span class="nc" id="L237">		DatabaseClass c = newDatabaseClass(n, comment);</span>
<span class="nc" id="L238">		classes.put(n, c.setAbstract(true));</span>
<span class="nc" id="L239">		return c;</span>
	}

	public final DatabaseClass addAbstractClass(String className, String comment, DatabaseClass superClass) {
<span class="nc" id="L243">		DatabaseClass c = addClass(className, comment, superClass);</span>
<span class="nc" id="L244">		c.setAbstract(true);</span>
<span class="nc" id="L245">		return c;</span>
	}

	public final DatabaseClass addAbstractClass(String className, String comment, DatabaseClass... superClasses) {
<span class="nc" id="L249">		DatabaseClass c = addClass(className, comment, superClasses);</span>
<span class="nc" id="L250">		c.setAbstract(true);</span>
<span class="nc" id="L251">		return c;</span>
	}

	public final Schema removeClass(String className) {
<span class="nc" id="L255">		classes.remove(className);</span>
<span class="nc" id="L256">		return this;</span>
	}

	public final boolean containsClass(String className) {
<span class="nc" id="L260">		return classes.containsKey(className);</span>
	}

	public final DatabaseClass getClass(Class&lt;?&gt; clazz) {
<span class="nc" id="L264">		return getClass(clazz.getName());</span>
	}

	public final DatabaseClass getClass(String className) {
<span class="nc" id="L268">		return classes.get(className);</span>
	}

	public final DatabaseClass getOrAddClass(String className) {
<span class="nc" id="L272">		DatabaseClass clazz = getClass(className);</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">		if (clazz != null) {</span>
<span class="nc" id="L274">			return clazz;</span>
		}
<span class="nc" id="L276">		return addClass(className, &quot;&quot;);</span>
	}

	public final DatabaseClass getOrAddClass(Class&lt;?&gt; clazz) {
<span class="nc" id="L280">		DatabaseClass c = getClass(clazz);</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">		if (c != null) {</span>
<span class="nc" id="L282">			return c;</span>
		}
<span class="nc" id="L284">		return addClass(clazz, &quot;&quot;);</span>
	}

	public final DatabaseClass getOrAddClass(String className, DatabaseClass superClass) {
<span class="nc" id="L288">		DatabaseClass c = getOrAddClass(className);</span>
<span class="nc" id="L289">		c.setSuperClass(superClass);</span>
<span class="nc" id="L290">		return c;</span>
	}

	public final DatabaseClass getOrAddClass(String className, DatabaseClass... superClasses) {
<span class="nc" id="L294">		DatabaseClass c = getOrAddClass(className);</span>
<span class="nc bnc" id="L295" title="All 4 branches missed.">		if (superClasses != null &amp;&amp; superClasses.length &gt;= 1) {</span>
<span class="nc" id="L296">			c.setSuperClass(superClasses[0]);</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">			for (int i = 1; i &lt; superClasses.length; i++) {</span>
<span class="nc" id="L298">				DatabaseClass superClass = superClasses[i];</span>
<span class="nc" id="L299">				c.addSuperClass(superClass);</span>
			}
		}
<span class="nc" id="L302">		return c;</span>
	}

	public final Collection&lt;DatabaseClass&gt; getClasses() {
<span class="nc" id="L306">		return classes.values();</span>
	}

	public final int countClasses() {
<span class="nc" id="L310">		return classes.size();</span>
	}

	public final DatabaseFunction addFunction(String name, String comment) {
<span class="nc" id="L314">		DatabaseFunction f = newDatabaseFunction(name, comment);</span>
<span class="nc" id="L315">		functions.put(name, f);</span>
<span class="nc" id="L316">		return f;</span>
	}

	public final Schema removeFunctions(String name) {
<span class="nc" id="L320">		functions.remove(name);</span>
<span class="nc" id="L321">		return this;</span>
	}

	public final DatabaseFunction getFunction(String name) {
<span class="nc" id="L325">		return functions.get(name);</span>
	}

	public final boolean containsFunction(String name) {
<span class="nc" id="L329">		return functions.containsKey(name);</span>
	}

	public final Collection&lt;DatabaseFunction&gt; getFunctions() {
<span class="nc" id="L333">		return functions.values();</span>
	}

	public final int countFunctions() {
<span class="nc" id="L337">		return functions.size();</span>
	}

	public final DatabaseSequence addSequence(String name, String comment, Class&lt;?&gt; clazz, int increment) {
<span class="nc" id="L341">		DatabaseSequence s = new DatabaseSequence(name, comment, clazz, increment, this);</span>
<span class="nc" id="L342">		sequences.put(name, s);</span>
<span class="nc" id="L343">		return s;</span>
	}

	public final Schema removeSequence(String name) {
<span class="nc" id="L347">		sequences.remove(name);</span>
<span class="nc" id="L348">		return this;</span>
	}

	public final boolean containsSequence(String name) {
<span class="nc" id="L352">		return sequences.containsKey(name);</span>
	}

	public final Collection&lt;DatabaseSequence&gt; getSequences() {
<span class="nc" id="L356">		return sequences.values();</span>
	}

	public final DatabaseSequence getSequence(String name) {
<span class="nc" id="L360">		return sequences.get(name);</span>
	}

	public final DatabaseSequence getSequence(Class&lt;?&gt; clazz) {
<span class="nc bnc" id="L364" title="All 2 branches missed.">		for (DatabaseSequence sequence : getSequences()) {</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">			if (sequence.getJavaClass().equals(clazz)) {</span>
<span class="nc" id="L366">				return sequence;</span>
			}
<span class="nc" id="L368">		}</span>
<span class="nc" id="L369">		return null;</span>
	}

	public final int countSequences() {
<span class="nc" id="L373">		return sequences.size();</span>
	}

	public final DatabaseTrigger addTrigger(String name, String comment) {
<span class="nc" id="L377">		DatabaseTrigger t = newDatabaseTrigger(name, comment);</span>
<span class="nc" id="L378">		triggers.put(name, t);</span>
<span class="nc" id="L379">		return t;</span>
	}

	public final Schema removeTrigger(String name) {
<span class="nc" id="L383">		triggers.remove(name);</span>
<span class="nc" id="L384">		return this;</span>
	}

	public final DatabaseTrigger getTrigger(String name) {
<span class="nc" id="L388">		return triggers.get(name);</span>
	}

	public final boolean containsTrigger(String name) {
<span class="nc" id="L392">		return triggers.containsKey(name);</span>
	}

	public final Collection&lt;DatabaseTrigger&gt; getTriggers() {
<span class="nc" id="L396">		return triggers.values();</span>
	}

	public final int countTriggers() {
<span class="nc" id="L400">		return triggers.size();</span>
	}

	public final DatabaseView addView(Class&lt;?&gt; target, String comment) {
<span class="nc" id="L404">		DatabaseView f = newDatabaseView(target, comment);</span>
<span class="nc" id="L405">		views.put(target.getName(), f);</span>
<span class="nc" id="L406">		return f;</span>
	}

	public final Schema removeView(Class&lt;?&gt; target) {
<span class="nc" id="L410">		views.remove(target.getName());</span>
<span class="nc" id="L411">		return this;</span>
	}

	public final DatabaseView getView(Class&lt;?&gt; target) {
<span class="nc" id="L415">		return views.get(target.getName());</span>
	}

	public final boolean containsView(Class&lt;?&gt; target) {
<span class="nc" id="L419">		return views.containsKey(target.getName());</span>
	}

	public final Collection&lt;DatabaseView&gt; getViews() {
<span class="nc" id="L423">		return views.values();</span>
	}

	public final int countViews() {
<span class="nc" id="L427">		return views.size();</span>
	}

	public final DatabaseUser addUser(String name, String password) {
<span class="nc" id="L431">		DatabaseUser user = new DatabaseUser(name, password);</span>
<span class="nc" id="L432">		users.put(name, user);</span>
<span class="nc" id="L433">		user.setSchema(this);</span>
<span class="nc" id="L434">		return user;</span>
	}

	public final Schema removeUser(String name) {
<span class="nc" id="L438">		users.remove(name);</span>
<span class="nc" id="L439">		return this;</span>
	}

	public final boolean containsUser(String name) {
<span class="nc bnc" id="L443" title="All 2 branches missed.">		if (owner.getUsername().equals(name)) {</span>
<span class="nc" id="L444">			return true;</span>
		}
<span class="nc" id="L446">		return users.containsKey(name);</span>
	}

	public final Collection&lt;DatabaseUser&gt; getUsers() {
<span class="nc" id="L450">		List&lt;DatabaseUser&gt; all = new ArrayList&lt;DatabaseUser&gt;();</span>
<span class="nc" id="L451">		all.add(owner);</span>
<span class="nc" id="L452">		all.addAll(users.values());</span>
<span class="nc" id="L453">		return all;</span>
	}

	public final DatabaseUser getUser(String name) {
<span class="nc" id="L457">		return users.get(name);</span>
	}

	public final int countUsers() {
<span class="nc" id="L461">		return users.size() + 1;</span>
	}

	public final DatabaseUser getOwner() {
<span class="nc" id="L465">		return owner;</span>
	}

	@Override
	public final int hashCode() {
<span class="nc" id="L470">		final int prime = 31;</span>
<span class="nc" id="L471">		int result = 1;</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">		result = prime * result + ((classes == null) ? 0 : classes.hashCode());</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">		result = prime * result + ((functions == null) ? 0 : functions.hashCode());</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">		result = prime * result + ((location == null) ? 0 : location.hashCode());</span>
<span class="nc bnc" id="L475" title="All 2 branches missed.">		result = prime * result + ((owner == null) ? 0 : owner.hashCode());</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">		result = prime * result + ((triggers == null) ? 0 : triggers.hashCode());</span>
<span class="nc bnc" id="L477" title="All 2 branches missed.">		result = prime * result + ((users == null) ? 0 : users.hashCode());</span>
<span class="nc" id="L478">		result = prime * result + version;</span>
<span class="nc bnc" id="L479" title="All 2 branches missed.">		result = prime * result + ((views == null) ? 0 : views.hashCode());</span>
<span class="nc" id="L480">		return result;</span>
	}

	@Override
	public final boolean equals(Object obj) {
<span class="nc bnc" id="L485" title="All 2 branches missed.">		if (this == obj)</span>
<span class="nc" id="L486">			return true;</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">		if (obj == null)</span>
<span class="nc" id="L488">			return false;</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">		if (getClass() != obj.getClass())</span>
<span class="nc" id="L490">			return false;</span>
<span class="nc" id="L491">		AbstractSchema other = (AbstractSchema) obj;</span>
<span class="nc bnc" id="L492" title="All 2 branches missed.">		if (classes == null) {</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">			if (other.classes != null)</span>
<span class="nc" id="L494">				return false;</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">		} else if (!classes.equals(other.classes)) {</span>
<span class="nc" id="L496">			return false;</span>
		}
<span class="nc bnc" id="L498" title="All 2 branches missed.">		if (functions == null) {</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">			if (other.functions != null)</span>
<span class="nc" id="L500">				return false;</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">		} else if (!functions.equals(other.functions)) {</span>
<span class="nc" id="L502">			return false;</span>
		}
<span class="nc bnc" id="L504" title="All 2 branches missed.">		if (location == null) {</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">			if (other.location != null)</span>
<span class="nc" id="L506">				return false;</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">		} else if (!location.equals(other.location)) {</span>
<span class="nc" id="L508">			return false;</span>
		}
<span class="nc bnc" id="L510" title="All 2 branches missed.">		if (owner == null) {</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">			if (other.owner != null)</span>
<span class="nc" id="L512">				return false;</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">		} else if (!owner.equals(other.owner)) {</span>
<span class="nc" id="L514">			return false;</span>
		}
<span class="nc bnc" id="L516" title="All 2 branches missed.">		if (triggers == null) {</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">			if (other.triggers != null)</span>
<span class="nc" id="L518">				return false;</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">		} else if (!triggers.equals(other.triggers)) {</span>
<span class="nc" id="L520">			return false;</span>
		}
<span class="nc bnc" id="L522" title="All 2 branches missed.">		if (users == null) {</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">			if (other.users != null)</span>
<span class="nc" id="L524">				return false;</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">		} else if (!users.equals(other.users)) {</span>
<span class="nc" id="L526">			return false;</span>
		}
<span class="nc bnc" id="L528" title="All 2 branches missed.">		if (version != other.version)</span>
<span class="nc" id="L529">			return false;</span>
<span class="nc bnc" id="L530" title="All 2 branches missed.">		if (views == null) {</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">			if (other.views != null)</span>
<span class="nc" id="L532">				return false;</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">		} else if (!views.equals(other.views)) {</span>
<span class="nc" id="L534">			return false;</span>
		}
<span class="nc" id="L536">		return true;</span>
	}

	public final int getVersion() {
<span class="nc" id="L540">		return version;</span>
	}

	public final String getLocation() {
<span class="nc" id="L544">		return location;</span>
	}

	public final ContainerFactory getContainerFactory() {
<span class="nc" id="L548">		return containerFactory;</span>
	}

	public final PrologProvider getProvider() {
<span class="nc" id="L552">		return provider;</span>
	}

	public final PrologEngine getEngine() {
<span class="nc" id="L556">		return storage.getEngine();</span>
	}

	public final Storage getStorage() {
<span class="nc" id="L560">		return storage;</span>
	}

	public final RelationalGraph&lt;DatabaseClass, DatabaseClass&gt; getGraph() {
<span class="nc" id="L564">		DatabaseClass relationEdge = addAbstractClass(RelationalEdge.class, &quot;&quot;);</span>
<span class="nc" id="L565">		RelationalGraph&lt;DatabaseClass, DatabaseClass&gt; g = new RelationalGraph&lt;DatabaseClass, DatabaseClass&gt;();</span>
<span class="nc bnc" id="L566" title="All 2 branches missed.">		for (DatabaseClass clazz : new ArrayList&lt;DatabaseClass&gt;(classes.values())) {</span>
<span class="nc bnc" id="L567" title="All 4 branches missed.">			if (!clazz.equals(relationEdge) &amp;&amp; !clazz.isSubClassOf(relationEdge)) {</span>
<span class="nc bnc" id="L568" title="All 2 branches missed.">				if (g.getVertex(clazz) == null) {</span>
<span class="nc" id="L569">					g.addVertex(clazz);</span>
				}
<span class="nc bnc" id="L571" title="All 2 branches missed.">				for (DatabaseField field : clazz.getFields()) {</span>
<span class="nc" id="L572">					Class&lt;?&gt; type = field.getType();</span>
<span class="nc bnc" id="L573" title="All 4 branches missed.">					if (type != null &amp;&amp; isRelationalType(type)) {</span>
<span class="nc" id="L574">						type = field.getLinkedType();</span>
					}
<span class="nc bnc" id="L576" title="All 4 branches missed.">					if (type != null &amp;&amp; !isJavaLangType(type)) {</span>
<span class="nc" id="L577">						DatabaseClass linkedClass = getClass(type);</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">						if (linkedClass != null) {</span>
<span class="nc" id="L579">							DatabaseField inKey = clazz.getPrimaryKeyField();</span>
<span class="nc" id="L580">							DatabaseField outKey = linkedClass.getPrimaryKeyField();</span>
<span class="nc" id="L581">							String inName = linkedClass.getName() + clazz.getName();</span>
<span class="nc" id="L582">							String outName = clazz.getName() + linkedClass.getName();</span>
<span class="nc" id="L583">							DatabaseClass in = getOrAddClass(inName, relationEdge);</span>
<span class="nc" id="L584">							DatabaseClass out = getOrAddClass(outName, relationEdge);</span>
<span class="nc" id="L585">							in.addField(inKey);</span>
<span class="nc" id="L586">							in.addField(outKey);</span>
<span class="nc" id="L587">							out.addField(outKey);</span>
<span class="nc" id="L588">							out.addField(inKey);</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">							if (g.getVertex(linkedClass) == null) {</span>
<span class="nc" id="L590">								g.addVertex(linkedClass);</span>
							}
<span class="nc" id="L592">							g.addEdge(linkedClass, clazz, out, Direction.IN);</span>
<span class="nc" id="L593">							g.addEdge(clazz, linkedClass, in, Direction.OUT);</span>
						}
					}
<span class="nc" id="L596">				}</span>
			}
<span class="nc" id="L598">		}</span>
<span class="nc" id="L599">		return g;</span>
	}

	public final List&lt;Class&lt;?&gt;&gt; getJavaClasses() {
<span class="nc" id="L603">		int size = countClasses();</span>
<span class="nc" id="L604">		List&lt;Class&lt;?&gt;&gt; l = new ArrayList&lt;Class&lt;?&gt;&gt;(size);</span>
<span class="nc bnc" id="L605" title="All 2 branches missed.">		for (DatabaseClass c : getClasses()) {</span>
<span class="nc" id="L606">			l.add(c.getJavaClass());</span>
<span class="nc" id="L607">		}</span>
<span class="nc" id="L608">		return l;</span>
	}

	public final void clear() {
<span class="nc" id="L612">		sequences.clear();</span>
<span class="nc" id="L613">		functions.clear();</span>
<span class="nc" id="L614">		classes.clear();</span>
<span class="nc" id="L615">		users.clear();</span>
<span class="nc" id="L616">	}</span>

	public final Schema load() {
<span class="nc" id="L619">		storage.getTransaction().begin();</span>
<span class="nc" id="L620">		List&lt;DatabaseUser&gt; u = storage.findAll(DatabaseUser.class);</span>
<span class="nc bnc" id="L621" title="All 2 branches missed.">		for (DatabaseUser databaseUser : u) {</span>
<span class="nc" id="L622">			users.put(databaseUser.getUsername(), databaseUser.setSchema(this));</span>
<span class="nc" id="L623">		}</span>
<span class="nc" id="L624">		List&lt;DatabaseClass&gt; c = storage.findAll(DatabaseClass.class);</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">		for (DatabaseClass databaseClass : c) {</span>
<span class="nc" id="L626">			classes.put(databaseClass.getName(), databaseClass.setSchema(this));</span>
<span class="nc" id="L627">		}</span>
<span class="nc" id="L628">		List&lt;PrologDatabaseFunction&gt; f = storage.findAll(PrologDatabaseFunction.class);</span>
<span class="nc bnc" id="L629" title="All 2 branches missed.">		for (DatabaseFunction databaseFunction : f) {</span>
<span class="nc" id="L630">			databaseFunction.setSchema(this);</span>
<span class="nc" id="L631">			databaseFunction.setEngine(getEngine());</span>
<span class="nc" id="L632">			databaseFunction.setProvider(getProvider());</span>
<span class="nc" id="L633">			functions.put(databaseFunction.getName(), databaseFunction);</span>
<span class="nc" id="L634">		}</span>
<span class="nc" id="L635">		List&lt;DatabaseSequence&gt; s = storage.findAll(DatabaseSequence.class);</span>
<span class="nc bnc" id="L636" title="All 2 branches missed.">		for (DatabaseSequence databaseSequence : s) {</span>
<span class="nc" id="L637">			sequences.put(databaseSequence.getName(), databaseSequence.setSchema(this));</span>
<span class="nc" id="L638">		}</span>
<span class="nc" id="L639">		List&lt;DatabaseTrigger&gt; t = storage.findAll(DatabaseTrigger.class);</span>
<span class="nc bnc" id="L640" title="All 2 branches missed.">		for (DatabaseTrigger databaseTrigger : t) {</span>
<span class="nc" id="L641">			databaseTrigger.setSchema(this);</span>
<span class="nc" id="L642">			databaseTrigger.setEngine(getEngine());</span>
<span class="nc" id="L643">			databaseTrigger.setProvider(getProvider());</span>
<span class="nc" id="L644">			triggers.put(databaseTrigger.getName(), databaseTrigger);</span>
<span class="nc" id="L645">		}</span>
<span class="nc" id="L646">		List&lt;DatabaseView&gt; v = storage.findAll(DatabaseView.class);</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">		for (DatabaseView databaseView : v) {</span>
<span class="nc" id="L648">			databaseView.setSchema(this);</span>
<span class="nc" id="L649">			databaseView.setEngine(getEngine());</span>
<span class="nc" id="L650">			databaseView.setProvider(getProvider());</span>
<span class="nc" id="L651">			views.put(databaseView.getName(), databaseView);</span>
<span class="nc" id="L652">		}</span>
<span class="nc" id="L653">		storage.getTransaction().close();</span>
<span class="nc" id="L654">		return this;</span>
	}

	public final void flush() {
<span class="nc" id="L658">		storage.getTransaction().begin();</span>
<span class="nc bnc" id="L659" title="All 2 branches missed.">		for (DatabaseUser user : getUsers()) {</span>
<span class="nc" id="L660">			storage.insert(user);</span>
<span class="nc" id="L661">		}</span>
<span class="nc bnc" id="L662" title="All 2 branches missed.">		for (DatabaseClass clazz : getClasses()) {</span>
<span class="nc" id="L663">			storage.insert(clazz);</span>
<span class="nc" id="L664">		}</span>
<span class="nc bnc" id="L665" title="All 2 branches missed.">		for (DatabaseFunction function : getFunctions()) {</span>
<span class="nc" id="L666">			storage.insert(function);</span>
<span class="nc" id="L667">			function.save();</span>
<span class="nc" id="L668">		}</span>
<span class="nc bnc" id="L669" title="All 2 branches missed.">		for (DatabaseSequence sequence : getSequences()) {</span>
<span class="nc" id="L670">			storage.insert(sequence);</span>
<span class="nc" id="L671">		}</span>
<span class="nc bnc" id="L672" title="All 2 branches missed.">		for (DatabaseTrigger trigger : getTriggers()) {</span>
<span class="nc" id="L673">			storage.insert(trigger);</span>
<span class="nc" id="L674">			trigger.save();</span>
<span class="nc" id="L675">		}</span>
<span class="nc bnc" id="L676" title="All 2 branches missed.">		for (DatabaseView view : getViews()) {</span>
<span class="nc" id="L677">			storage.insert(view);</span>
<span class="nc" id="L678">			view.save();</span>
<span class="nc" id="L679">		}</span>
		try {
<span class="nc" id="L681">			storage.getTransaction().commit();</span>
<span class="nc" id="L682">		} catch (Exception e) {</span>
<span class="nc" id="L683">			storage.rollback();</span>
<span class="nc" id="L684">		}</span>
<span class="nc" id="L685">		storage.getTransaction().close();</span>
<span class="nc" id="L686">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>